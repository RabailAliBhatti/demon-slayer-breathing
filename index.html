<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEMON SLAYER: BREATHING TECHNIQUE</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1632090090/camera_utils.js" crossorigin="anonymous"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{
  --night:#040410;
  --sakura:#FFB7C5;
  --crimson:#8B0000;
  --crimson-bright:#CC0000;
  --panel-bg:rgba(4,4,20,0.92);
  --panel-border:rgba(139,0,0,0.35);
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--night);font-family:'Cinzel',serif;user-select:none;}

#threeCanvas{position:fixed;inset:0;z-index:1;}
#fxCanvas{position:fixed;inset:0;z-index:2;pointer-events:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GESTURE WINDOW â€” the whole panel
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#gestureWindow {
  position: fixed;
  bottom: 24px;
  left: 24px;
  width: 240px;
  z-index: 60;
  display: none;
  flex-direction: column;
  gap: 0;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid var(--panel-border);
  box-shadow: 0 0 30px rgba(139,0,0,0.25), 0 8px 32px rgba(0,0,0,0.7);
  animation: panelSlideIn 0.4s cubic-bezier(0.16,1,0.3,1) forwards;
}
@keyframes panelSlideIn {
  from { opacity:0; transform:translateY(20px) scale(0.96); }
  to   { opacity:1; transform:translateY(0)    scale(1);    }
}

/* Panel header bar */
#gestureWindow .gw-header {
  background: rgba(139,0,0,0.18);
  border-bottom: 1px solid var(--panel-border);
  padding: 7px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
#gestureWindow .gw-header .gw-title {
  font-size: 0.42rem;
  letter-spacing: 0.35em;
  color: rgba(255,183,197,0.7);
  text-transform: uppercase;
}
#gestureWindow .gw-header .gw-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: #CC0000;
  box-shadow: 0 0 6px #CC0000;
  animation: dotPulse 1.4s ease-in-out infinite;
}
@keyframes dotPulse {
  0%,100%{ opacity:1; transform:scale(1); }
  50%    { opacity:0.4; transform:scale(0.7); }
}

/* Camera + skeleton overlay */
#camContainer {
  position: relative;
  width: 240px;
  height: 180px;
  background: #000;
  overflow: hidden;
}
#webcam {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transform: scaleX(-1); /* mirror */
  opacity: 0.75;
  display: block;
}
#skeletonCanvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
}

/* Gesture name overlay on camera */
#gestureLabel {
  position: absolute;
  bottom: 8px;
  left: 0; right: 0;
  text-align: center;
  font-family: 'Cinzel Decorative', serif;
  font-size: 0.65rem;
  letter-spacing: 0.2em;
  color: #fff;
  text-shadow: 0 0 12px currentColor;
  pointer-events: none;
  transition: opacity 0.2s;
}

/* Speed bar */
#speedBarWrap {
  background: var(--panel-bg);
  border-top: 1px solid var(--panel-border);
  padding: 7px 12px 5px;
}
#speedBarWrap .sb-label {
  font-size: 0.38rem;
  letter-spacing: 0.3em;
  color: rgba(255,183,197,0.45);
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
}
#speedBarTrack {
  height: 4px;
  background: rgba(255,255,255,0.07);
  border-radius: 2px;
  overflow: hidden;
}
#speedBarFill {
  height: 100%;
  width: 0%;
  border-radius: 2px;
  background: linear-gradient(to right, #8B0000, #FF2222);
  transition: width 0.1s linear, background 0.3s;
  box-shadow: 0 0 6px rgba(204,0,0,0.6);
}

/* Finger indicators row */
#fingerRow {
  background: var(--panel-bg);
  border-top: 1px solid var(--panel-border);
  padding: 8px 12px;
  display: flex;
  align-items: flex-end;
  justify-content: space-around;
  gap: 6px;
}
.finger-col {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.finger-col .fn { /* finger name */
  font-size: 0.34rem;
  letter-spacing: 0.12em;
  color: rgba(255,255,255,0.25);
  text-transform: uppercase;
}
.finger-col .fb { /* finger bar */
  width: 10px;
  border-radius: 5px 5px 0 0;
  background: rgba(255,255,255,0.08);
  transition: height 0.15s ease, background 0.2s, box-shadow 0.2s;
  min-height: 4px;
}
.finger-col .fb.up {
  background: #4FC3F7;
  box-shadow: 0 0 8px #4FC3F780;
}
.finger-col .fb.thumb-up {
  background: #FFE066;
  box-shadow: 0 0 8px #FFE06680;
}

/* Status row */
#statusRow {
  background: var(--panel-bg);
  border-top: 1px solid var(--panel-border);
  padding: 7px 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
#statusRow .status-icon {
  font-size: 0.85rem;
  transition: transform 0.2s;
}
#statusRow .status-text {
  font-size: 0.42rem;
  letter-spacing: 0.22em;
  color: var(--sakura);
  flex:1;
  transition: color 0.2s;
}
#statusRow .status-text.detected {
  color: #FFE066;
}
#statusRow .status-text.triggered {
  color: #FF4444;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ui{position:fixed;inset:0;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;}
.deco-line{width:1px;height:70px;background:linear-gradient(to bottom,transparent,var(--crimson),transparent);margin-bottom:20px;opacity:0;animation:fadeUp 1s ease-out 0.3s forwards;}
.kanji{font-size:0.65rem;letter-spacing:0.5em;color:var(--crimson-bright);opacity:0;animation:fadeUp 0.8s ease-out 0.6s forwards;margin-bottom:14px;text-shadow:0 0 20px rgba(204,0,0,0.5);}
h1{font-family:'Cinzel Decorative',serif;font-size:clamp(1.5rem,3.8vw,3rem);font-weight:900;color:#fff;text-align:center;letter-spacing:0.08em;line-height:1.2;text-shadow:0 0 10px rgba(255,255,255,0.8),0 0 40px rgba(139,0,0,0.8),0 0 100px rgba(139,0,0,0.3);opacity:0;animation:fadeUp 1s ease-out 0.9s forwards;padding:0 20px;}
h1 span{display:block;font-size:0.42em;letter-spacing:0.4em;color:var(--sakura);text-shadow:0 0 20px rgba(255,183,197,0.5);margin-top:8px;font-weight:400;}
.divider{display:flex;align-items:center;gap:14px;margin:22px 0;opacity:0;animation:fadeUp 0.8s ease-out 1.3s forwards;}
.dl{width:70px;height:1px;background:linear-gradient(to right,transparent,var(--crimson));}
.dl.r{background:linear-gradient(to left,transparent,var(--crimson));}
.dd{width:6px;height:6px;background:var(--crimson-bright);transform:rotate(45deg);box-shadow:0 0 10px var(--crimson-bright);}
.cta{font-size:clamp(0.55rem,1.3vw,0.8rem);letter-spacing:0.4em;color:rgba(255,255,255,0.65);opacity:0;animation:fadeUp 0.8s ease-out 1.6s forwards,ctaPulse 2.5s ease-in-out 2.8s infinite;}
.warn{font-size:0.55rem;letter-spacing:0.2em;color:rgba(255,183,197,0.35);margin-top:10px;opacity:0;animation:fadeUp 0.8s ease-out 1.9s forwards;}
.hand-hint{font-size:0.5rem;letter-spacing:0.25em;color:rgba(255,183,197,0.22);margin-top:6px;opacity:0;animation:fadeUp 0.8s ease-out 2.1s forwards;}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
@keyframes ctaPulse{0%,100%{opacity:0.45;transform:scale(1);}50%{opacity:1;transform:scale(1.03);}}

#counter{position:fixed;bottom:28px;left:280px;z-index:20;opacity:0;animation:fadeUp 0.8s ease-out 2.2s forwards;}
#counter .lbl{font-size:0.5rem;letter-spacing:0.3em;color:rgba(255,183,197,0.6);display:block;margin-bottom:3px;}
#counter .num{font-family:'Cinzel Decorative',serif;font-size:1.7rem;color:#fff;text-shadow:0 0 20px rgba(139,0,0,0.9);display:block;transition:transform 0.15s ease;}
#counter .num.pop{transform:scale(1.5);}

#styleBox{position:fixed;bottom:28px;right:36px;z-index:20;text-align:right;opacity:0;animation:fadeUp 0.8s ease-out 2.2s forwards;}
#styleBox .sname{font-family:'Cinzel Decorative',serif;font-size:0.72rem;letter-spacing:0.18em;display:block;min-height:1em;transition:color 0.3s,text-shadow 0.3s;}
#styleBox .slbl{font-size:0.45rem;letter-spacing:0.3em;color:rgba(255,255,255,0.25);display:block;margin-top:4px;}

#brand{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:20;text-align:center;opacity:0;animation:fadeUp 0.8s ease-out 2.4s forwards;pointer-events:all;}
#brand .bname{font-size:0.6rem;letter-spacing:0.35em;color:var(--sakura);display:block;margin-bottom:5px;opacity:0.75;}
#brand .links{display:flex;gap:14px;justify-content:center;}
#brand .links a{font-size:0.48rem;letter-spacing:0.2em;color:rgba(139,0,0,0.7);text-decoration:none;transition:color 0.25s,text-shadow 0.25s;}
#brand .links a:hover{color:#fff;text-shadow:0 0 8px rgba(255,255,255,0.4);}
#brand .links .sep{color:rgba(255,255,255,0.12);font-size:0.48rem;}

#muteBtn{position:fixed;top:24px;right:28px;z-index:20;background:rgba(255,255,255,0.04);border:1px solid rgba(139,0,0,0.3);color:rgba(255,255,255,0.5);font-size:1rem;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;opacity:0;animation:fadeUp 0.8s ease-out 2.4s forwards;pointer-events:all;}
#muteBtn:hover{background:rgba(139,0,0,0.15);border-color:var(--crimson-bright);color:#fff;}

#camBtn{position:fixed;top:24px;left:28px;z-index:20;background:rgba(255,255,255,0.04);border:1px solid rgba(139,0,0,0.3);color:rgba(255,255,255,0.5);font-size:0.5rem;letter-spacing:0.15em;padding:8px 14px;border-radius:20px;cursor:pointer;transition:all 0.2s;opacity:0;animation:fadeUp 0.8s ease-out 2.4s forwards;pointer-events:all;white-space:nowrap;}
#camBtn:hover{background:rgba(139,0,0,0.15);border-color:var(--crimson-bright);color:#fff;}
#camBtn.active{border-color:#FFB7C5;color:#FFB7C5;background:rgba(255,183,197,0.08);}

#flash{position:fixed;inset:0;z-index:30;pointer-events:none;opacity:0;}
#announce{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:40;pointer-events:none;opacity:0;text-align:center;}
#announce .aname{font-family:'Cinzel Decorative',serif;font-size:clamp(1.1rem,3vw,2rem);letter-spacing:0.2em;display:block;}
#announce .asub{font-size:clamp(0.5rem,1.2vw,0.68rem);letter-spacing:0.45em;color:rgba(255,255,255,0.55);display:block;margin-top:8px;}

.moon{position:fixed;top:7%;right:10%;width:65px;height:65px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#fffde8,#f0d080);box-shadow:0 0 20px rgba(240,208,128,0.3),0 0 60px rgba(240,208,128,0.1);z-index:1;opacity:0;animation:fadeUp 2s ease-out 0.1s forwards;}
.mountains{position:fixed;bottom:0;left:0;right:0;height:32vh;z-index:3;pointer-events:none;}
.mountains svg{width:100%;height:100%;}
</style>
</head>
<body>

<canvas id="threeCanvas"></canvas>
<canvas id="fxCanvas"></canvas>
<div class="moon"></div>

<div class="mountains">
  <svg viewBox="0 0 1440 300" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="mg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#0a0018" stop-opacity="0.96"/>
        <stop offset="100%" stop-color="#040410" stop-opacity="1"/>
      </linearGradient>
    </defs>
    <path d="M0,300 L0,200 L120,120 L240,180 L360,80 L480,160 L600,60 L680,130 L760,40 L860,140 L960,70 L1080,150 L1200,90 L1320,170 L1440,100 L1440,300 Z" fill="url(#mg)"/>
    <path d="M0,300 L0,250 L100,215 L220,230 L340,190 L460,220 L580,180 L700,215 L820,172 L940,208 L1060,175 L1180,210 L1300,182 L1440,205 L1440,300 Z" fill="#040410" opacity="0.85"/>
  </svg>
</div>

<div id="ui">
  <div class="deco-line"></div>
  <div class="kanji">é¬¼æ»…ã®åˆƒ Â· Kimetsu no Yaiba</div>
  <h1>Demon Slayer<span>Breathing Technique</span></h1>
  <div class="divider"><div class="dl"></div><div class="dd"></div><div class="dl r"></div></div>
  <div class="cta">â€” Click or Wave Your Hand â€”</div>
  <div class="warn">âš  &nbsp; Audio Â· Visual Â· Gesture Detection</div>
  <div class="hand-hint">âœ‹ &nbsp; Enable camera top-left to use hand gestures</div>
</div>

<div id="counter"><span class="lbl">TOTAL BREATHS</span><span class="num" id="breathNum">0</span></div>
<div id="styleBox"><span class="sname" id="snameEl"></span><span class="slbl">BREATHING STYLE</span></div>

<div id="brand">
  <span class="bname">[YOUR NAME]</span>
  <div class="links">
    <a href="https://instagram.com" target="_blank">Instagram</a>
    <span class="sep">Â·</span>
    <a href="https://yourwebsite.com" target="_blank">Website</a>
  </div>
</div>

<button id="muteBtn">ğŸ”Š</button>
<button id="camBtn">ğŸ“· &nbsp;HAND GESTURES</button>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GESTURE WINDOW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="gestureWindow">

  <!-- Header -->
  <div class="gw-header">
    <span class="gw-title">Gesture Vision Â· æ‰‹å‹¢</span>
    <span class="gw-dot"></span>
  </div>

  <!-- Camera + skeleton overlay -->
  <div id="camContainer">
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="skeletonCanvas"></canvas>
    <div id="gestureLabel">â€”</div>
  </div>

  <!-- Swipe speed bar -->
  <div id="speedBarWrap">
    <div class="sb-label">
      <span>SWIPE POWER</span>
      <span id="speedPct">0%</span>
    </div>
    <div id="speedBarTrack">
      <div id="speedBarFill"></div>
    </div>
  </div>

  <!-- Finger extension indicators -->
  <div id="fingerRow">
    <div class="finger-col">
      <div class="fb" id="fb-thumb" style="height:22px"></div>
      <div class="fn">THB</div>
    </div>
    <div class="finger-col">
      <div class="fb" id="fb-index" style="height:22px"></div>
      <div class="fn">IDX</div>
    </div>
    <div class="finger-col">
      <div class="fb" id="fb-middle" style="height:22px"></div>
      <div class="fn">MID</div>
    </div>
    <div class="finger-col">
      <div class="fb" id="fb-ring" style="height:22px"></div>
      <div class="fn">RNG</div>
    </div>
    <div class="finger-col">
      <div class="fb" id="fb-pinky" style="height:22px"></div>
      <div class="fn">PNK</div>
    </div>
  </div>

  <!-- Status -->
  <div id="statusRow">
    <span class="status-icon" id="statusIcon">ğŸ¤š</span>
    <span class="status-text" id="statusText">AWAITING HANDâ€¦</span>
  </div>

</div>

<div id="flash"></div>
<div id="announce">
  <span class="aname" id="announceName"></span>
  <span class="asub"  id="announceSub"></span>
</div>

<script>
'use strict';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STYLES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STYLES = [
  { name:'WATER BREATHING',  announce:'WATER BREATHING',  formEn:'FIRST FORM: WATER SURFACE SLASH',       color:'#4FC3F7', secondary:'#0077B6', glow:'#00B4D8', particles:['#4FC3F7','#A8DADC','#ffffff','#90E0EF'], slashCount:1, sound:'water'  },
  { name:'FLAME BREATHING',  announce:'FLAME BREATHING',  formEn:'FIRST FORM: UNKNOWING FIRE',             color:'#FF6B35', secondary:'#CC0000', glow:'#FF4500', particles:['#FF6B35','#FFD700','#CC0000','#FF8C00'], slashCount:1, sound:'flame'  },
  { name:'THUNDER BREATHING',announce:'THUNDER BREATHING',formEn:'FIRST FORM: THUNDERCLAP AND FLASH',      color:'#FFE066', secondary:'#FFA000', glow:'#FFD700', particles:['#FFE066','#FFFFFF','#FFD700','#FFF9C4'], slashCount:3, sound:'thunder'},
  { name:'WIND BREATHING',   announce:'WIND BREATHING',   formEn:'FIRST FORM: DUST WHIRLWIND CUTTER',     color:'#81C784', secondary:'#2E7D32', glow:'#66BB6A', particles:['#81C784','#C8E6C9','#A5D6A7','#ffffff'], slashCount:2, sound:'wind'   },
  { name:'MOON BREATHING',   announce:'MOON BREATHING',   formEn:'FIRST FORM: DARK MOON, EVENING PALACE', color:'#CE93D8', secondary:'#6A1B9A', glow:'#AB47BC', particles:['#CE93D8','#E1BEE7','#9C27B0','#ffffff'], slashCount:1, sound:'moon'   },
  { name:'SUN BREATHING',    announce:'SUN BREATHING',    formEn:'DANCE OF THE FIRE GOD Â· WALTZ',         color:'#FFD54F', secondary:'#E65100', glow:'#FFCA28', particles:['#FFD54F','#FFECB3','#FF8F00','#FFFFFF'], slashCount:5, sound:'sun'    },
];
const BLOOD_DEMON = {
  name:'BLOOD DEMON ART', announce:'BLOOD DEMON ART', formEn:'æ‚ªé¬¼æ»…æ®º Â· DEVOUR ALL DEMONS',
  color:'#CC0000', secondary:'#8B0000', glow:'#FF2222',
  particles:['#CC0000','#FF4444','#8B0000','#FFB7C5'], slashCount:4, sound:'blood',
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let breathCount    = 0;
let muted          = false;
let audioCtx       = null;
let masterGain     = null;
let ambientStarted = false;
let currentStyle   = null;
let camActive      = false;
let lastGestureTime= 0;
let prevWristPos   = null;
let swipeBuffer    = [];
let currentSpeed   = 0;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// THREE.JS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const threeCanvas = document.getElementById('threeCanvas');
const renderer    = new THREE.WebGLRenderer({ canvas:threeCanvas, antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x000000, 0);

const scene  = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,0,5);

const starGeo = new THREE.BufferGeometry();
const STAR_COUNT = 800;
const starPos = new Float32Array(STAR_COUNT*3);
for(let i=0;i<STAR_COUNT;i++){starPos[i*3]=(Math.random()-.5)*40;starPos[i*3+1]=(Math.random()-.5)*25;starPos[i*3+2]=(Math.random()-.5)*20-5;}
starGeo.setAttribute('position',new THREE.BufferAttribute(starPos,3));
const starPoints=new THREE.Points(starGeo,new THREE.PointsMaterial({color:0xffffff,size:.03,transparent:true,opacity:.7}));
scene.add(starPoints);

const orbMat  = new THREE.MeshBasicMaterial({color:0x8B0000,transparent:true,opacity:0,wireframe:true});
const orbMesh = new THREE.Mesh(new THREE.SphereGeometry(.25,24,24),orbMat);
scene.add(orbMesh);

let activeSlashes=[], activeParticles=[], activeRings=[];
let shakeIntensity=0, shakeDuration=0, driftX=0, driftY=0;

function triggerShake(intensity,duration){shakeIntensity=intensity;shakeDuration=duration;}

function screenTo3D(sx,sy,targetZ=0){
  const ndc=new THREE.Vector3((sx/window.innerWidth)*2-1,-(sy/window.innerHeight)*2+1,.5);
  ndc.unproject(camera);
  const dir=ndc.sub(camera.position).normalize();
  if(Math.abs(dir.z)<.0001)return new THREE.Vector3(0,0,targetZ);
  const dist=(targetZ-camera.position.z)/dir.z;
  return camera.position.clone().add(dir.multiplyScalar(dist));
}

function spawn3DSlash(sx,sy,style){
  const origin=screenTo3D(sx,sy,0);
  const count=style.slashCount||1;
  for(let s=0;s<count;s++){
    const spread=count>1?(s/(count-1)-.5)*1.2:0;
    const angleRad=((-25+Math.random()*50)*Math.PI/180)+spread*.4;
    const len=5.5+Math.random()*3;
    const pts=[];
    for(let i=0;i<=14;i++){
      const t=i/14;
      pts.push(new THREE.Vector3(
        origin.x+(t-.5)*len*Math.cos(angleRad),
        origin.y+(t-.5)*len*Math.sin(angleRad)+Math.sin(t*Math.PI*2.5)*.18,
        Math.sin(t*Math.PI)*.35*(s%2===0?1:-1)
      ));
    }
    const curve=new THREE.CatmullRomCurve3(pts);
    const coreMat=new THREE.MeshBasicMaterial({color:new THREE.Color(style.color),transparent:true,opacity:1,side:THREE.DoubleSide});
    const glowMat=new THREE.MeshBasicMaterial({color:new THREE.Color(style.glow),transparent:true,opacity:.28,side:THREE.DoubleSide});
    const coreMesh=new THREE.Mesh(new THREE.TubeGeometry(curve,24,.014+s*.004,6,false),coreMat);
    const glowMesh=new THREE.Mesh(new THREE.TubeGeometry(curve,24,.055+s*.008,4,false),glowMat);
    scene.add(coreMesh); scene.add(glowMesh);
    activeSlashes.push({coreMesh,glowMesh,coreMat,glowMat,life:1,decay:.02+s*.004});
  }
}

function spawn3DParticles(sx,sy,style,count=50){
  const origin=screenTo3D(sx,sy,0);
  const positions=new Float32Array(count*3);
  const velocities=[];
  for(let i=0;i<count;i++){
    positions[i*3]=origin.x+(Math.random()-.5)*.2;
    positions[i*3+1]=origin.y+(Math.random()-.5)*.2;
    positions[i*3+2]=origin.z+(Math.random()-.5)*.2;
    const angle=Math.random()*Math.PI*2,elev=(Math.random()-.5)*Math.PI,spd=.035+Math.random()*.11;
    velocities.push({vx:Math.cos(elev)*Math.cos(angle)*spd,vy:Math.cos(elev)*Math.sin(angle)*spd,vz:Math.sin(elev)*spd});
  }
  const geo=new THREE.BufferGeometry();
  const attr=new THREE.BufferAttribute(positions,3);
  attr.setUsage(THREE.DynamicDrawUsage);
  geo.setAttribute('position',attr);
  const col=style.particles[Math.floor(Math.random()*style.particles.length)];
  const mat=new THREE.PointsMaterial({color:new THREE.Color(col),size:.06+Math.random()*.05,transparent:true,opacity:1,sizeAttenuation:true});
  const pts=new THREE.Points(geo,mat);
  scene.add(pts);
  activeParticles.push({pts,geo,attr,mat,velocities,life:1,decay:.016,count});
}

function spawn3DRing(sx,sy,style,delayMs=0){
  setTimeout(()=>{
    const origin=screenTo3D(sx,sy,0);
    const mat=new THREE.MeshBasicMaterial({color:new THREE.Color(style.color),transparent:true,opacity:.9,side:THREE.DoubleSide});
    const mesh=new THREE.Mesh(new THREE.RingGeometry(.01,.05,64),mat);
    mesh.position.copy(origin);
    mesh.rotation.x=(Math.random()-.5)*.5; mesh.rotation.y=(Math.random()-.5)*.5;
    scene.add(mesh);
    activeRings.push({mesh,mat,life:1,decay:.018,maxScale:7+Math.random()*5});
  },delayMs);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2D FX CANVAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fxCanvas=document.getElementById('fxCanvas');
const fxCtx=fxCanvas.getContext('2d');
const DPR=Math.min(window.devicePixelRatio||1,2);
let canvasW=window.innerWidth,canvasH=window.innerHeight;

function resizeFx(){
  canvasW=window.innerWidth; canvasH=window.innerHeight;
  fxCanvas.width=canvasW*DPR; fxCanvas.height=canvasH*DPR;
  fxCanvas.style.width=canvasW+'px'; fxCanvas.style.height=canvasH+'px';
  fxCtx.setTransform(DPR,0,0,DPR,0,0);
}
resizeFx();

let petals=[];
function initPetals(){petals=[];for(let i=0;i<60;i++)petals.push(mkPetal(true));}
function mkPetal(rand=false){
  const d=Math.random();
  return{x:Math.random()*canvasW,y:rand?Math.random()*canvasH:-15,vx:(Math.random()-.5)*.5,vy:.35+Math.random()*1.1+d*.7,rot:Math.random()*Math.PI*2,rs:(Math.random()-.5)*.035,sz:2.5+Math.random()*4.5+d*3,op:.15+d*.45,phase:Math.random()*Math.PI*2,depth:d,col:Math.random()<.72?'#FFB7C5':'#fff'};
}
function updatePetals(t){
  for(const p of petals){p.x+=p.vx+Math.sin(t*.00045+p.phase)*.35;p.y+=p.vy;p.rot+=p.rs;if(p.y>canvasH+15)Object.assign(p,mkPetal(false));}
}
function drawPetal(p){
  fxCtx.save();fxCtx.translate(p.x,p.y);fxCtx.rotate(p.rot);fxCtx.globalAlpha=p.op;fxCtx.fillStyle=p.col;
  fxCtx.beginPath();fxCtx.ellipse(0,0,p.sz*.45,p.sz,0,0,Math.PI*2);fxCtx.fill();fxCtx.restore();
}
initPetals();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUDIO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initAudio(){if(audioCtx)return;audioCtx=new(window.AudioContext||window.webkitAudioContext)();masterGain=audioCtx.createGain();masterGain.gain.value=.75;masterGain.connect(audioCtx.destination);}
function mkGain(peak,atk,rel){const g=audioCtx.createGain(),now=audioCtx.currentTime;g.gain.setValueAtTime(.0001,now);g.gain.linearRampToValueAtTime(peak,now+atk);g.gain.exponentialRampToValueAtTime(.0001,now+atk+rel);return g;}
function mkOsc(type,freq){const o=audioCtx.createOscillator();o.type=type;o.frequency.value=freq;return o;}
function mkFilt(type,freq,Q=1){const f=audioCtx.createBiquadFilter();f.type=type;f.frequency.value=freq;f.Q.value=Q;return f;}
function mkReverb(){const conv=audioCtx.createConvolver(),len=Math.floor(audioCtx.sampleRate*1.2),buf=audioCtx.createBuffer(2,len,audioCtx.sampleRate);for(let c=0;c<2;c++){const d=buf.getChannelData(c);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2.8);}conv.buffer=buf;return conv;}
function chainReverb(node,wet=.22){const conv=mkReverb(),wg=audioCtx.createGain();wg.gain.value=wet;node.connect(conv);conv.connect(wg);wg.connect(masterGain);}
function noiseBuf(sec){const len=Math.floor(audioCtx.sampleRate*sec),buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<len;i++)d[i]=Math.random()*2-1;return buf;}

function playWater(){
  [220,330,440,550].forEach((f,i)=>{const o=mkOsc('sine',f+Math.random()*15),flt=mkFilt('bandpass',f*1.4,3.5),g=mkGain(.16-i*.025,.015,.7+i*.25);o.connect(flt);flt.connect(g);g.connect(masterGain);chainReverb(g,.3);o.start();o.stop(audioCtx.currentTime+1.4);});
  const drop=mkOsc('sine',900);drop.frequency.exponentialRampToValueAtTime(180,audioCtx.currentTime+.18);const dg=mkGain(.28,.002,.18);drop.connect(dg);dg.connect(masterGain);chainReverb(dg,.4);drop.start();drop.stop(audioCtx.currentTime+.22);
}
function playFlame(){
  const ns=audioCtx.createBufferSource();ns.buffer=noiseBuf(.45);const nf=mkFilt('bandpass',320,1.8),ng=mkGain(.42,.004,.42);ns.connect(nf);nf.connect(ng);ng.connect(masterGain);ns.start();
  const roar=mkOsc('sawtooth',65);roar.frequency.exponentialRampToValueAtTime(28,audioCtx.currentTime+.45);const rf=mkFilt('lowpass',180,3),rg=mkGain(.38,.008,.55);roar.connect(rf);rf.connect(rg);rg.connect(masterGain);roar.start();roar.stop(audioCtx.currentTime+.65);
  const crackLen=Math.floor(audioCtx.sampleRate*.1),crackBuf=audioCtx.createBuffer(1,crackLen,audioCtx.sampleRate),cd=crackBuf.getChannelData(0);for(let i=0;i<crackLen;i++)cd[i]=Math.random()<.04?(Math.random()*2-1)*2.5:0;const cs=audioCtx.createBufferSource();cs.buffer=crackBuf;const cf=mkFilt('highpass',1800,1),cg=mkGain(.28,.001,.09);cs.connect(cf);cf.connect(cg);cg.connect(masterGain);cs.start();
}
function playThunder(){
  const snap=audioCtx.createBufferSource();snap.buffer=noiseBuf(.06);const sf=mkFilt('highpass',1800,2),sg=mkGain(.65,.001,.05);snap.connect(sf);sf.connect(sg);sg.connect(masterGain);snap.start();
  [880,1320,2640].forEach((freq,idx)=>{const buzz=mkOsc('square',freq),bflt=mkFilt('bandpass',freq,7),bgn=mkGain(.07-idx*.018,.002,.07+idx*.02);buzz.connect(bflt);bflt.connect(bgn);bgn.connect(masterGain);buzz.start();buzz.stop(audioCtx.currentTime+.14);});
  const boom=mkOsc('sine',90);boom.frequency.exponentialRampToValueAtTime(22,audioCtx.currentTime+.32);const bg=mkGain(.55,.008,.45);boom.connect(bg);bg.connect(masterGain);boom.start();boom.stop(audioCtx.currentTime+.5);
}
function playWind(){
  const wind=audioCtx.createBufferSource();wind.buffer=noiseBuf(.65);const wf1=mkFilt('bandpass',750,.7),wf2=mkFilt('highpass',380,1),wg=mkGain(.28,.025,.6);wind.connect(wf1);wf1.connect(wf2);wf2.connect(wg);wg.connect(masterGain);chainReverb(wg,.3);wind.start();
  const whistle=mkOsc('sine',880+Math.random()*200);whistle.frequency.linearRampToValueAtTime(380,audioCtx.currentTime+.45);const wgw=mkGain(.14,.012,.4);whistle.connect(wgw);wgw.connect(masterGain);whistle.start();whistle.stop(audioCtx.currentTime+.55);
}
function playMoon(){
  [[55,.22],[82,.14],[110,.08]].forEach(([f,pk],i)=>{const o=mkOsc('sine',f+(Math.random()*6-3)),flt=mkFilt('lowpass',f*2.8,1.5),g=mkGain(pk,.06,1.4+i*.4);o.connect(flt);flt.connect(g);g.connect(masterGain);chainReverb(g,.4);o.start();o.stop(audioCtx.currentTime+2.2);});
  const sweep=mkOsc('triangle',320);sweep.frequency.exponentialRampToValueAtTime(55,audioCtx.currentTime+.9);const sg=mkGain(.22,.02,.9);sweep.connect(sg);sg.connect(masterGain);chainReverb(sg,.45);sweep.start();sweep.stop(audioCtx.currentTime+1.1);
}
function playSun(){
  [220,277,330,440,554].forEach((f,i)=>{const o=mkOsc(i%2===0?'sine':'triangle',f),g=mkGain(.16-i*.018,.03,1+i*.18);o.connect(g);g.connect(masterGain);chainReverb(g,.28);o.start();o.stop(audioCtx.currentTime+1.8);});
  const rise=mkOsc('sawtooth',90);rise.frequency.exponentialRampToValueAtTime(650,audioCtx.currentTime+.55);const rflt=mkFilt('bandpass',380,2),rgn=mkGain(.32,.01,.5);rise.connect(rflt);rflt.connect(rgn);rgn.connect(masterGain);rise.start();rise.stop(audioCtx.currentTime+.65);
}
function playBloodDemon(){
  const growl=audioCtx.createBufferSource();growl.buffer=noiseBuf(1.3);const gFilt=mkFilt('lowpass',280,9),gGain=mkGain(.55,.006,1.2);growl.connect(gFilt);gFilt.connect(gGain);gGain.connect(masterGain);chainReverb(gGain,.45);growl.start();
  [[80,.38],[55,.28],[40,.2]].forEach(([f,pk],i)=>{const o=mkOsc('sine',f*2);o.frequency.exponentialRampToValueAtTime(f,audioCtx.currentTime+.55);const g=mkGain(pk-i*.06,.01,1);o.connect(g);g.connect(masterGain);o.start();o.stop(audioCtx.currentTime+1.2);});
  const screech=mkOsc('sawtooth',2200);screech.frequency.exponentialRampToValueAtTime(180,audioCtx.currentTime+.32);const scFlt=mkFilt('bandpass',900,4),scGn=mkGain(.22,.001,.3);screech.connect(scFlt);scFlt.connect(scGn);scGn.connect(masterGain);screech.start();screech.stop(audioCtx.currentTime+.38);
}
function startAmbient(){
  if(!audioCtx||ambientStarted)return; ambientStarted=true;
  const ag=audioCtx.createGain();ag.gain.setValueAtTime(0,audioCtx.currentTime);ag.gain.linearRampToValueAtTime(1,audioCtx.currentTime+5);ag.connect(masterGain);
  [[55,.032],[110,.013],[165,.007]].forEach(([f,g])=>{const o=audioCtx.createOscillator();o.type='sine';o.frequency.value=f;const og=audioCtx.createGain();og.gain.value=g;o.connect(og);og.connect(ag);o.start();});
}
function playSound(key){if(!audioCtx||muted)return;({water:playWater,flame:playFlame,thunder:playThunder,wind:playWind,moon:playMoon,sun:playSun,blood:playBloodDemon})[key]?.();}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FLASH + ANNOUNCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const flashEl=document.getElementById('flash');
const announceEl=document.getElementById('announce');
const aNameEl=document.getElementById('announceName');
const aSubEl=document.getElementById('announceSub');

function doFlash(css){
  flashEl.style.transition='none';flashEl.style.background=css;flashEl.style.opacity='1';
  requestAnimationFrame(()=>requestAnimationFrame(()=>{flashEl.style.transition='opacity 0.65s ease-out';flashEl.style.opacity='0';}));
}
function showAnnounce(name,sub,color){
  aNameEl.textContent=name;aNameEl.style.color=color;aNameEl.style.textShadow=`0 0 25px ${color},0 0 70px ${color}55`;aSubEl.textContent=sub;
  announceEl.style.transition='none';announceEl.style.opacity='1';announceEl.style.transform='translate(-50%,-50%) scale(1.25)';
  requestAnimationFrame(()=>requestAnimationFrame(()=>{announceEl.style.transition='opacity 1.2s ease-out,transform 1.2s ease-out';announceEl.style.opacity='0';announceEl.style.transform='translate(-50%,-50%) scale(0.88)';}));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BREATH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const breathNumEl=document.getElementById('breathNum');
const snameEl=document.getElementById('snameEl');

function doBreath(sx,sy){
  initAudio(); startAmbient();
  breathCount++;
  breathNumEl.textContent=breathCount;
  breathNumEl.classList.remove('pop');
  void breathNumEl.offsetWidth;
  breathNumEl.classList.add('pop');
  setTimeout(()=>breathNumEl.classList.remove('pop'),200);

  if(breathCount%7===0){
    doFlash(`radial-gradient(circle at ${sx}px ${sy}px,rgba(139,0,0,.8) 0%,rgba(60,0,0,.4) 35%,transparent 70%)`);
    spawn3DSlash(sx,sy,BLOOD_DEMON); spawn3DParticles(sx,sy,BLOOD_DEMON,90);
    [0,160,320,480].forEach(d=>spawn3DRing(sx,sy,BLOOD_DEMON,d));
    triggerShake(.2,45); playSound('blood');
    showAnnounce('BLOOD DEMON ART','æ‚ªé¬¼æ»…æ®º Â· DEVOUR ALL DEMONS',BLOOD_DEMON.color);
    return;
  }

  let style;
  do{style=STYLES[Math.floor(Math.random()*STYLES.length)];}while(style===currentStyle&&STYLES.length>1);
  currentStyle=style;
  snameEl.textContent=style.name; snameEl.style.color=style.color; snameEl.style.textShadow=`0 0 18px ${style.color}`;

  spawn3DSlash(sx,sy,style); spawn3DParticles(sx,sy,style,55);
  spawn3DRing(sx,sy,style,0); spawn3DRing(sx,sy,style,200);
  doFlash(`radial-gradient(ellipse at 50% 50%,${style.glow}44 0%,${style.glow}18 40%,transparent 75%)`);
  triggerShake(style.sound==='thunder'?.1:style.sound==='sun'?.08:.05, style.sound==='thunder'?38:20);
  playSound(style.sound);
  showAnnounce(style.announce,style.formEn,style.color);
}

document.addEventListener('click',e=>doBreath(e.clientX,e.clientY));
document.addEventListener('touchstart',e=>{e.preventDefault();doBreath(e.touches[0].clientX,e.touches[0].clientY);},{passive:false});

const muteBtn=document.getElementById('muteBtn');
muteBtn.addEventListener('click',e=>{e.stopPropagation();muted=!muted;muteBtn.textContent=muted?'ğŸ”‡':'ğŸ”Š';if(masterGain)masterGain.gain.linearRampToValueAtTime(muted?0:.75,audioCtx.currentTime+.1);});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GESTURE WINDOW â€” skeleton drawing + analysis
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const gestureWindow = document.getElementById('gestureWindow');
const webcamEl      = document.getElementById('webcam');
const skelCanvas    = document.getElementById('skeletonCanvas');
const skelCtx       = skelCanvas.getContext('2d');
const gestureLabelEl= document.getElementById('gestureLabel');
const speedBarFill  = document.getElementById('speedBarFill');
const speedPctEl    = document.getElementById('speedPct');
const statusIcon    = document.getElementById('statusIcon');
const statusText    = document.getElementById('statusText');

const fbEls = {
  thumb:  document.getElementById('fb-thumb'),
  index:  document.getElementById('fb-index'),
  middle: document.getElementById('fb-middle'),
  ring:   document.getElementById('fb-ring'),
  pinky:  document.getElementById('fb-pinky'),
};

// Resize skeleton canvas to match container
function resizeSkelCanvas(){
  const container = document.getElementById('camContainer');
  skelCanvas.width  = container.offsetWidth;
  skelCanvas.height = container.offsetHeight;
}

// MediaPipe hand connections
const HAND_CONNECTIONS = [
  [0,1],[1,2],[2,3],[3,4],           // thumb
  [0,5],[5,6],[6,7],[7,8],           // index
  [0,9],[9,10],[10,11],[11,12],      // middle
  [0,13],[13,14],[14,15],[15,16],    // ring
  [0,17],[17,18],[18,19],[19,20],    // pinky
  [5,9],[9,13],[13,17],              // palm
];

// Finger tip + MCP pairs for extension detection
const FINGER_PAIRS = {
  thumb:  { tip:4,  base:2  },
  index:  { tip:8,  base:6  },
  middle: { tip:12, base:10 },
  ring:   { tip:16, base:14 },
  pinky:  { tip:20, base:18 },
};

function isFingerUp(lm, tipIdx, baseIdx, isThumb=false) {
  if (isThumb) {
    return Math.abs(lm[tipIdx].x - lm[baseIdx].x) > 0.06;
  }
  return lm[tipIdx].y < lm[baseIdx].y - 0.03;
}

// Classify the gesture name
function classifyGesture(lm, fingersUpMap, speed) {
  const { thumb, index, middle, ring, pinky } = fingersUpMap;
  const upCount = [index,middle,ring,pinky].filter(Boolean).length;

  if (speed > 0.22) return { name:'âš” SLASH', color:'#FF4444', icon:'âš”ï¸' };
  if (upCount === 4 && thumb) return { name:'âœ‹ OPEN PALM', color:'#FFE066', icon:'âœ‹' };
  if (upCount === 4 && !thumb) return { name:'ğŸ– FOUR FINGERS', color:'#4FC3F7', icon:'ğŸ–ï¸' };
  if (index && !middle && !ring && !pinky) return { name:'â˜ POINT', color:'#81C784', icon:'â˜ï¸' };
  if (index && middle && !ring && !pinky) return { name:'âœŒ PEACE', color:'#CE93D8', icon:'âœŒï¸' };
  if (!index && !middle && !ring && !pinky && !thumb) return { name:'âœŠ FIST', color:'#FF6B35', icon:'âœŠ' };
  if (thumb && !index && !middle && !ring && pinky) return { name:'ğŸ¤™ HANG LOOSE', color:'#FFD54F', icon:'ğŸ¤™' };
  if (upCount === 0 && thumb) return { name:'ğŸ‘ THUMBS UP', color:'#66BB6A', icon:'ğŸ‘' };
  if (upCount >= 2) return { name:'ğŸ¤š PARTIAL', color:'rgba(255,183,197,0.8)', icon:'ğŸ¤š' };
  return { name:'â€” IDLE', color:'rgba(255,255,255,0.3)', icon:'ğŸ¤š' };
}

// Draw skeleton on the skeleton canvas
function drawSkeleton(lm, gesture, fingersUpMap) {
  const W = skelCanvas.width;
  const H = skelCanvas.height;
  skelCtx.clearRect(0, 0, W, H);

  // Mirror x because webcam is mirrored in CSS
  const px = (x) => (1 - x) * W;
  const py = (y) => y * H;

  // Glow color based on gesture
  const glowColor = gesture.color;

  // Draw connections
  skelCtx.lineWidth = 2;
  for (const [a, b] of HAND_CONNECTIONS) {
    const ax = px(lm[a].x), ay = py(lm[a].y);
    const bx = px(lm[b].x), by = py(lm[b].y);

    skelCtx.beginPath();
    skelCtx.moveTo(ax, ay);
    skelCtx.lineTo(bx, by);

    // Gradient along each bone
    const grad = skelCtx.createLinearGradient(ax, ay, bx, by);
    grad.addColorStop(0, glowColor + 'CC');
    grad.addColorStop(1, glowColor + '55');
    skelCtx.strokeStyle = grad;
    skelCtx.shadowBlur  = 8;
    skelCtx.shadowColor = glowColor;
    skelCtx.stroke();
  }

  // Draw landmark dots
  lm.forEach((pt, idx) => {
    const x = px(pt.x), y = py(pt.y);
    const isTip = [4,8,12,16,20].includes(idx);
    const r = isTip ? 5 : 3;

    skelCtx.beginPath();
    skelCtx.arc(x, y, r, 0, Math.PI*2);
    skelCtx.fillStyle = isTip ? '#FFFFFF' : glowColor;
    skelCtx.shadowBlur  = isTip ? 12 : 6;
    skelCtx.shadowColor = glowColor;
    skelCtx.fill();
  });

  // Wrist glow pulse
  skelCtx.beginPath();
  skelCtx.arc(px(lm[0].x), py(lm[0].y), 8, 0, Math.PI*2);
  skelCtx.strokeStyle = glowColor;
  skelCtx.lineWidth = 1.5;
  skelCtx.globalAlpha = 0.5 + Math.sin(Date.now()*0.006)*0.3;
  skelCtx.stroke();
  skelCtx.globalAlpha = 1;
  skelCtx.shadowBlur  = 0;
}

// Update the finger bar indicators
function updateFingerBars(fingersUpMap) {
  const entries = [
    ['thumb',  fingersUpMap.thumb,  true],
    ['index',  fingersUpMap.index,  false],
    ['middle', fingersUpMap.middle, false],
    ['ring',   fingersUpMap.ring,   false],
    ['pinky',  fingersUpMap.pinky,  false],
  ];
  entries.forEach(([name, isUp, isThumb]) => {
    const el = fbEls[name];
    el.style.height = isUp ? '32px' : '8px';
    el.classList.toggle(isThumb ? 'thumb-up' : 'up', isUp);
    if (!isUp) { el.classList.remove('up'); el.classList.remove('thumb-up'); }
  });
}

// Smooth speed decay
let displaySpeed = 0;

function updateSpeedBar(rawSpeed) {
  displaySpeed += (rawSpeed - displaySpeed) * 0.25;
  const pct = Math.min(100, Math.round(displaySpeed * 300));
  speedBarFill.style.width = pct + '%';
  speedPctEl.textContent   = pct + '%';
  // Change bar color based on power
  if (pct > 70) {
    speedBarFill.style.background = 'linear-gradient(to right,#CC0000,#FF4444)';
    speedBarFill.style.boxShadow  = '0 0 10px rgba(255,50,50,0.8)';
  } else if (pct > 35) {
    speedBarFill.style.background = 'linear-gradient(to right,#FF6B35,#FFD700)';
    speedBarFill.style.boxShadow  = '0 0 8px rgba(255,180,0,0.6)';
  } else {
    speedBarFill.style.background = 'linear-gradient(to right,#8B0000,#CC0000)';
    speedBarFill.style.boxShadow  = '0 0 6px rgba(204,0,0,0.5)';
  }
}

// Main gesture analysis â€” called every frame from MediaPipe
function analyzeHand(lm) {
  // Finger extension
  const fingersUpMap = {
    thumb:  isFingerUp(lm, FINGER_PAIRS.thumb.tip,  FINGER_PAIRS.thumb.base,  true),
    index:  isFingerUp(lm, FINGER_PAIRS.index.tip,  FINGER_PAIRS.index.base),
    middle: isFingerUp(lm, FINGER_PAIRS.middle.tip, FINGER_PAIRS.middle.base),
    ring:   isFingerUp(lm, FINGER_PAIRS.ring.tip,   FINGER_PAIRS.ring.base),
    pinky:  isFingerUp(lm, FINGER_PAIRS.pinky.tip,  FINGER_PAIRS.pinky.base),
  };

  // Swipe speed from wrist
  const wrist = lm[0];
  if (prevWristPos) {
    const dx = wrist.x - prevWristPos.x;
    const dy = wrist.y - prevWristPos.y;
    swipeBuffer.push({ dx, dy });
    if (swipeBuffer.length > 8) swipeBuffer.shift();

    const sumDx = swipeBuffer.reduce((a,f)=>a+f.dx,0);
    const sumDy = swipeBuffer.reduce((a,f)=>a+f.dy,0);
    currentSpeed = Math.sqrt(sumDx*sumDx + sumDy*sumDy);

    const now = Date.now();
    if (currentSpeed > 0.2 && (now - lastGestureTime) > 650) {
      lastGestureTime = now;
      swipeBuffer = [];
      const sx = (1 - wrist.x) * window.innerWidth;
      const sy = wrist.y * window.innerHeight;
      doBreath(sx, sy);
    }
  }
  prevWristPos = { x: wrist.x, y: wrist.y };

  // Classify
  const gesture = classifyGesture(lm, fingersUpMap, currentSpeed);

  // Update UI
  updateFingerBars(fingersUpMap);
  updateSpeedBar(currentSpeed);
  drawSkeleton(lm, gesture, fingersUpMap);

  // Gesture label overlay on camera
  gestureLabelEl.textContent = gesture.name;
  gestureLabelEl.style.color = gesture.color;
  gestureLabelEl.style.textShadow = `0 0 10px ${gesture.color}`;

  // Status row
  statusIcon.textContent = gesture.icon;
  const isSlash = currentSpeed > 0.22;
  statusText.textContent = isSlash
    ? (currentSpeed > 0.4 ? 'FULL POWER SLASH!' : 'SLASH DETECTED!')
    : gesture.name.replace(/[^ ]+ /,'');
  statusText.className = 'status-text ' + (isSlash ? 'triggered' : currentSpeed > 0.05 ? 'detected' : '');

  // Decay speed display
  currentSpeed *= 0.85;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MEDIAPIPE INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let handsModel = null;
let mpCamera   = null;

function initMediaPipe() {
  if (handsModel) return;
  resizeSkelCanvas();

  handsModel = new Hands({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${f}`
  });
  handsModel.setOptions({
    maxNumHands:1, modelComplexity:1,
    minDetectionConfidence:.7, minTrackingConfidence:.6,
  });
  handsModel.onResults(res => {
    if (res.multiHandLandmarks?.length) {
      analyzeHand(res.multiHandLandmarks[0]);
    } else {
      // Clear when no hand
      skelCtx.clearRect(0,0,skelCanvas.width,skelCanvas.height);
      gestureLabelEl.textContent = 'â€” NO HAND â€”';
      gestureLabelEl.style.color = 'rgba(255,255,255,0.2)';
      statusIcon.textContent = 'ğŸ¤š';
      statusText.textContent = 'NO HAND DETECTED';
      statusText.className   = 'status-text';
      prevWristPos = null;
      swipeBuffer  = [];
      currentSpeed = 0;
      updateSpeedBar(0);
      updateFingerBars({thumb:false,index:false,middle:false,ring:false,pinky:false});
    }
  });

  mpCamera = new Camera(webcamEl, {
    onFrame: async () => { await handsModel.send({ image: webcamEl }); },
    width:320, height:240,
  });
  mpCamera.start().catch(err => {
    console.warn('Camera error:', err);
    statusText.textContent = 'CAMERA DENIED';
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CAMERA TOGGLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const camBtn = document.getElementById('camBtn');

camBtn.addEventListener('click', e => {
  e.stopPropagation();
  camActive = !camActive;

  if (camActive) {
    camBtn.classList.add('active');
    camBtn.textContent = 'âœ‹  GESTURE ACTIVE';
    gestureWindow.style.display = 'flex';
    // Move counter left to make room for gesture panel
    document.getElementById('counter').style.left = '280px';
    initMediaPipe();
  } else {
    camBtn.classList.remove('active');
    camBtn.textContent = 'ğŸ“· \u00a0HAND GESTURES';
    gestureWindow.style.display = 'none';
    document.getElementById('counter').style.left = '36px';
    if (mpCamera) { mpCamera.stop(); mpCamera = null; }
    handsModel   = null;
    prevWristPos = null;
    swipeBuffer  = [];
    currentSpeed = 0;
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESIZE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('resize', () => {
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  resizeFx();
  if (camActive) resizeSkelCanvas();
  for (const p of petals) { if(p.x>canvasW) p.x=Math.random()*canvasW; }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// THREE.JS RENDER LOOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let frameCount=0;
function animate3D(){
  requestAnimationFrame(animate3D);
  frameCount++;

  const targetDX=Math.sin(frameCount*.008)*.12;
  const targetDY=Math.cos(frameCount*.006)*.06;
  driftX+=(targetDX-driftX)*.025;
  driftY+=(targetDY-driftY)*.025;

  let shakeX=0,shakeY=0;
  if(shakeDuration>0){shakeX=(Math.random()-.5)*shakeIntensity;shakeY=(Math.random()-.5)*shakeIntensity;shakeDuration--;shakeIntensity*=.94;}

  camera.position.x=driftX+shakeX;
  camera.position.y=driftY+shakeY;
  camera.lookAt(0,0,0);

  starPoints.rotation.y=frameCount*.00025;
  orbMesh.rotation.x=frameCount*.007;
  orbMesh.rotation.y=frameCount*.011;
  orbMat.opacity=(0.5+Math.sin(frameCount*.04)*.5)*.065;

  for(let i=activeSlashes.length-1;i>=0;i--){
    const s=activeSlashes[i];s.life-=s.decay;
    if(s.life<=0){scene.remove(s.coreMesh);s.coreMesh.geometry.dispose();s.coreMat.dispose();scene.remove(s.glowMesh);s.glowMesh.geometry.dispose();s.glowMat.dispose();activeSlashes.splice(i,1);}
    else{s.coreMat.opacity=Math.pow(Math.max(0,s.life),.55);s.glowMat.opacity=Math.pow(Math.max(0,s.life),.55)*.3;}
  }
  for(let i=activeParticles.length-1;i>=0;i--){
    const p=activeParticles[i];p.life-=p.decay;
    if(p.life<=0){scene.remove(p.pts);p.geo.dispose();p.mat.dispose();activeParticles.splice(i,1);}
    else{const pos=p.attr.array;for(let j=0;j<p.count;j++){const v=p.velocities[j];pos[j*3]+=v.vx;v.vx*=.92;pos[j*3+1]+=v.vy;v.vy-=.0014;v.vy*=.92;pos[j*3+2]+=v.vz;v.vz*=.92;}p.attr.needsUpdate=true;p.mat.opacity=Math.pow(Math.max(0,p.life),.75);}
  }
  for(let i=activeRings.length-1;i>=0;i--){
    const r=activeRings[i];r.life-=r.decay;
    if(r.life<=0){scene.remove(r.mesh);r.mesh.geometry.dispose();r.mat.dispose();activeRings.splice(i,1);}
    else{const sc=r.maxScale*Math.pow(1-r.life,.5);r.mesh.scale.setScalar(Math.max(.01,sc));r.mat.opacity=r.life*.85;r.mesh.rotation.z+=.012;}
  }
  renderer.render(scene,camera);
}
animate3D();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2D PETAL LOOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop2D(t){
  fxCtx.clearRect(0,0,canvasW,canvasH);
  updatePetals(t);
  for(const p of petals)drawPetal(p);
  const vg=fxCtx.createRadialGradient(canvasW/2,canvasH/2,canvasH*.2,canvasW/2,canvasH/2,canvasH*.95);
  vg.addColorStop(0,'transparent');vg.addColorStop(1,'rgba(0,0,0,0.72)');
  fxCtx.fillStyle=vg;fxCtx.fillRect(0,0,canvasW,canvasH);
  requestAnimationFrame(loop2D);
}
requestAnimationFrame(loop2D);
</script>
</body>
</html>
